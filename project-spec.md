# 專案需求規格書 (PRD)：Discord Activity "無盡圈圈叉叉" PoC

## 1. 專案目標
本專案旨在開發一個基於 Discord Activity 環境的即時多人對戰遊戲原型。透過「會消失的圈圈叉叉 (Infinite Tic-Tac-Toe)」機制，驗證 Nakama Server 與 Discord Embedded App SDK 之間的即時通訊、狀態同步與身份驗證流程。

## 2. 技術架構概覽
- **客戶端 (Client)**: 使用 Discord Embedded App SDK 進行環境整合，前端框架使用 Vue & Vite。
- **後端伺服器 (Backend)**: 使用自建 Nakama Server (TypeScript Runtime) 作為權威伺服器 (Authoritative Server)。
- **通訊協定**: 透過 WebSocket 進行全雙工即時資料交換。
- **身份驗證**: 串接 Discord OAuth2 流程，將 Discord User ID 映射至 Nakama 帳號系統。

## 3. 核心遊戲邏輯 (Game Logic)
本遊戲為標準 3x3 棋盤，但在經典邏輯上加入「先進先出 (FIFO)」的動態限制：
- **最大落子數**: 每位玩家在棋盤上最多只能同時存在 3 個標記（圈或叉）。
- **動態移除機制**: 當玩家放置第 4 個標記時，該玩家最早放置（第一手）的標記必須從棋盤上移除。
- **狀態流轉**: 後端需維護每位玩家的落子佇列（Queue），每次落子後需重新計算棋盤狀態並檢查勝負。
- **勝負判定**: 棋盤上任意時刻出現橫向、縱向或對角線連成 3 個相同標記，則該玩家獲勝。
- **和局機制**: 暫不實作。

## 4. 功能需求規格

### 4.1 房間與玩家管理
- **頻道綁定**: Activity 應根據使用者所在的 Discord 語音頻道 ID 自動建立或加入對應的 Nakama Match (房間)。
- **角色分配**: 進入活動時預設為「觀戰者」，需點擊「加入遊戲」按鈕才能成為玩家。
- **加入遊戲按鈕**: 僅在有空位（少於 2 位玩家）時顯示，先按先得。
- **玩家離開處理**: 若對戰中的玩家離開（斷線或主動退出），判定對手獲勝，遊戲結束。
- **房間生命週期**: 當所有人離開語音頻道後，房間立即關閉。

### 4.2 遊戲流程
- **準備階段**: 兩位玩家皆需點擊「準備」按鈕，雙方都準備完成後遊戲開始。
- **準備超時**: 若玩家超過 30 秒未點擊準備，對方可將其踢出使其變為觀戰者。
- **先手決定**: 遊戲開始時隨機決定先手。
- **回合限時**: 每回合限時 30 秒，超時由系統隨機選擇一個合法位置落子。
- **重賽機制**: 遊戲結束後需雙方同意重賽，選擇「不同意」的玩家將脫離成為觀戰者，重賽時先後手重新隨機決定。

### 4.3 即時通訊需求 (OpCodes)
後端需處理以下關鍵事件：
- **落子請求 (Move Input)**: 接收玩家座標，驗證合法性（是否輪到該玩家、位置是否為空）。
- **狀態廣播 (State Sync)**: 每當棋盤變動，後端需向所有連線客戶端廣播最新棋盤陣列及落子序列資訊。
- **遊戲結束 (Game End)**: 結算勝負並進入重賽確認流程。
- **玩家加入/離開**: 廣播玩家狀態變化。
- **準備狀態**: 廣播玩家準備狀態。
- **踢出玩家**: 處理準備超時的踢出請求。

### 4.4 使用者體驗 (UX)
- **玩家資訊顯示**: 顯示玩家的 Discord 大頭貼與暱稱。
- **棋子呈現**: 使用玩家大頭貼作為棋子，右下角疊加小型 ○/✕ 符號以區分陣營。
- **視覺預告**: 前端應根據後端傳回的序列資訊，將「即將消失」的標記以不同視覺樣式（如閃爍或半透明）呈現。
- **同步回饋**: 為補償網路延遲，前端需實作基礎的狀態預測，但在收到後端正式狀態時需進行強制校正。
- **觀戰者互動**: 使用 Discord 原生介面，不另外製作聊天功能。

## 5. 非功能需求
- **延遲目標**: 操作響應與狀態更新的往返時間 (RTT) 應控制在 100ms 以內（以台灣伺服器節點為準）。
- **可擴展性**: 後端邏輯需模組化，以便未來擴張至更大棋盤 (如 5x5) 或加入其他道具機制。
- **安全性**: 所有遊戲狀態計算必須在 Nakama 伺服器端完成，客戶端僅負責渲染與發送操作指令。

## 6. 驗證指標 (PoC Success Criteria)
- 兩名玩家能從不同的 Discord 客戶端進入同一語音頻道並成功開始遊戲。
- 放置第 4 手棋時，第 1 手棋能正確在所有參與者的畫面中消失。
- 一方獲勝時，雙方客戶端能同步彈出結算視窗並正確顯示贏家資訊。
- 玩家超時 30 秒後系統能自動隨機落子。
- 玩家離開時對手能正確獲得勝利判定。
- 重賽流程能正確執行（同意/不同意機制）。
