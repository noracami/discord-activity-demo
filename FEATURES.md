# åŠŸèƒ½éœ€æ±‚

## å·²å®Œæˆ

### FEAT-003: é€£ç·šæ¢å¾©æ©Ÿåˆ¶
- **ç‹€æ…‹:** âœ… Completed
- **å„ªå…ˆç´š:** Medium
- **ç›¸é—œ Bug:** BUG-002
- **å®Œæˆæ—¥æœŸ:** 2025-01-03

#### èƒŒæ™¯
ç›®å‰ç©å®¶æ–·ç·šï¼ˆç¶²è·¯å•é¡Œæˆ–ä¼ºæœå™¨é‡å•Ÿï¼‰æœƒç›´æ¥åˆ¤å®šå°æ‰‹ç²å‹ï¼Œç„¡æ³•æ¢å¾©é€£ç·šã€‚

#### å¯¦ä½œå…§å®¹

**Phase 1 - Client é‡é€£**
- [x] Client æ–·ç·šåµæ¸¬ (`ondisconnect`)
- [x] è‡ªå‹•é‡é€£é‚è¼¯ï¼ˆæŒ‡æ•¸é€€é¿ï¼Œæœ€å¤š 5 æ¬¡ï¼‰
- [x] UI é¡¯ç¤ºã€Œé‡æ–°é€£ç·šä¸­...ã€overlay
- [x] å„²å­˜é€£ç·šåƒæ•¸ä¾›é‡é€£ä½¿ç”¨

**Phase 2 - æ–·ç·šå¯¬é™æœŸ**
- [x] ç©å®¶æ–·ç·šå¾Œæ¨™è¨˜ç‚º `isDisconnected`ï¼Œç­‰å¾… 30 ç§’
- [x] å°æ‰‹çœ‹åˆ°ã€Œå°æ‰‹å·²æ–·ç·šï¼Œç­‰å¾…é‡æ–°é€£ç·šä¸­...ã€è­¦å‘Š
- [x] é‡é€£æ™‚æ¢å¾©ç©å®¶ sessionï¼Œç¹¼çºŒéŠæˆ²
- [x] è¶…æ™‚æ‰åˆ¤å®šå°æ‰‹ç²å‹

**Phase 3 - State æŒä¹…åŒ–**
- [x] Match state æ¯ 5 ç§’å­˜å…¥ Nakama Storage
- [x] Match çµ‚æ­¢å‰å„²å­˜æœ€çµ‚ç‹€æ…‹
- [x] Server é‡å•Ÿå¾Œå¯å¾ Storage æ¢å¾©é€²è¡Œä¸­çš„å°å±€
- [x] ç‹€æ…‹éæœŸï¼ˆ1å°æ™‚ï¼‰è‡ªå‹•æ¸…ç†

#### æ–°å¢æª”æ¡ˆ
- `packages/nakama/src/match/storage.ts` - Storage åŠ©æ‰‹å‡½å¼

#### å”å®šæ“´å……
```typescript
// æ–°å¢ OpCode
PLAYER_DISCONNECTED = 111  // Server â†’ All: ç©å®¶æš«æ™‚æ–·ç·š
PLAYER_RECONNECTED = 112   // Server â†’ All: ç©å®¶å·²é‡é€£
```

#### è³‡æ–™çµæ§‹è®Šæ›´
```typescript
interface MatchPlayer {
  // ... ç¾æœ‰æ¬„ä½
  isDisconnected: boolean;
  disconnectedAtTick: number | null;
}
```

---

## è¦åŠƒä¸­

---

### FEAT-004: Client ç‰ˆæœ¬æª¢æŸ¥è‡ªå‹•æ›´æ–°
- **ç‹€æ…‹:** ğŸ“ Planned (å·²å¯¦ä½œä½†æš«æ™‚åœç”¨)
- **å„ªå…ˆç´š:** Medium
- **æè¿°:** éƒ¨ç½²æ–°ç‰ˆæœ¬æ™‚ï¼ŒèˆŠ Client è‡ªå‹• reload å–å¾—æœ€æ–°ç‰ˆæœ¬

#### èƒŒæ™¯
ç•¶éƒ¨ç½²æ–°ç‰ˆæœ¬æ™‚ï¼Œå·²é–‹å•Ÿçš„èˆŠ Client å¯èƒ½èˆ‡æ–° Server ä¸ç›¸å®¹ï¼Œéœ€è¦æ©Ÿåˆ¶è®“èˆŠ Client è‡ªå‹•æ›´æ–°ã€‚

#### å·²å¯¦ä½œå…§å®¹ (ç›®å‰åœç”¨)
- [x] æ–°å¢ `VERSION_CHECK` OpCode (113)
- [x] Build æ™‚æ³¨å…¥ `__CLIENT_VERSION__` å¸¸æ•¸
- [x] Server æ¯ 30 ç§’å»£æ’­ç‰ˆæœ¬è™Ÿ
- [x] Client æ”¶åˆ°ç‰ˆæœ¬ä¸ç¬¦æ™‚ reloadï¼ˆééŠæˆ²ä¸­ï¼‰

#### å·²çŸ¥å•é¡Œ
1. **tick 0 è§¸ç™¼å•é¡Œ:** `0 % 300 === 0` å°è‡´ match é–‹å§‹å°±è§¸ç™¼ï¼Œå·²ä¿®æ­£ä½†æœªé©—è­‰
2. **ç‰ˆæœ¬åŒæ­¥å•é¡Œ:** Client å’Œ Nakama éƒ¨ç½²æ™‚é–“å·®å°è‡´ç‰ˆæœ¬ä¸ä¸€è‡´
3. **reload æ™‚æ©Ÿå•é¡Œ:** åœ¨å¤§å»³ç­‰å¾…æ™‚ reload æœƒæ‰“æ–·ä½¿ç”¨è€…é«”é©—

#### å¾…è§£æ±º
- [ ] ç ”ç©¶æ›´å¥½çš„è§¸ç™¼æ™‚æ©Ÿï¼ˆä¾‹å¦‚ï¼šåªåœ¨é›¢é–‹ match æ™‚æª¢æŸ¥ï¼‰
- [ ] è€ƒæ…®é¡¯ç¤ºã€Œæœ‰æ–°ç‰ˆæœ¬å¯ç”¨ã€æç¤ºè€Œéç›´æ¥ reload
- [ ] ç¢ºä¿ Client å’Œ Nakama åŒæ™‚éƒ¨ç½²æˆ–æœ‰ graceful éæ¸¡æœŸ

#### ç›¸é—œæª”æ¡ˆ
- `packages/nakama/src/match/index.ts` - Server å»£æ’­é‚è¼¯ï¼ˆå·²è¨»è§£ï¼‰
- `apps/client/src/stores/game.store.ts` - Client è™•ç†é‚è¼¯ï¼ˆå·²è¨»è§£ï¼‰
- `packages/shared/src/opcodes.ts` - OpCode å®šç¾©

---

### FEAT-002: è¨­å®š Zeabur Watch Paths å„ªåŒ–éƒ¨ç½²
- **ç‹€æ…‹:** ğŸ“ Planned
- **å„ªå…ˆç´š:** Low
- **æè¿°:** ç›®å‰ä»»ä½•æª”æ¡ˆè®Šå‹•éƒ½æœƒè§¸ç™¼æ‰€æœ‰æœå‹™é‡æ–°éƒ¨ç½²

#### å»ºè­°è¨­å®š
| æœå‹™ | Watch Paths |
|------|-------------|
| Client | `apps/client/**`, `packages/shared/**` |
| Nakama | `packages/nakama/**`, `packages/shared/**` |

#### è¨­å®šæ–¹å¼
Zeabur Dashboard â†’ Service â†’ Settings â†’ Watch Paths

#### åƒè€ƒæ–‡ä»¶
[Watch Paths - Zeabur](https://zeabur.com/docs/en-US/deploy/watch-paths)

---

### FEAT-001: é€é curl æŸ¥è©¢ä¼ºæœå™¨ç«¯ log
- **ç‹€æ…‹:** ğŸ“ Planned
- **å„ªå…ˆç´š:** Low
- **æè¿°:** ç›®å‰åªèƒ½é€é Zeabur Dashboard æŸ¥çœ‹ Nakama ä¼ºæœå™¨ log

#### ç›®å‰ç‹€æ…‹
å·²æœ‰ `query_logs` RPC å¯æŸ¥è©¢å‰ç«¯é ç«¯ log

#### éœ€æ±‚
- [ ] å°‡ä¼ºæœå™¨ç«¯ `logger.info/warn/error` ä¹Ÿå­˜å…¥ Storage
- [ ] æˆ–æä¾› API ä»£ç† Zeabur/Nakama log æŸ¥è©¢

---

### FEAT-005: Server ç«¯å¿ƒè·³æ©Ÿåˆ¶åµæ¸¬æ–·ç·š
- **ç‹€æ…‹:** ğŸ“ Planned
- **å„ªå…ˆç´š:** Medium
- **æè¿°:** Discord Activity ç›´æ¥é—œé–‰æ™‚ï¼ŒWebSocket å¯èƒ½æ²’æœ‰æ­£ç¢ºæ–·é–‹ï¼ŒServer ç„¡æ³•åµæ¸¬ç©å®¶é›¢é–‹

#### èƒŒæ™¯
ç•¶ç”¨æˆ¶ç›´æ¥é›¢é–‹ Discord é »é“æˆ–é—œé–‰ Activity æ™‚ï¼ŒDiscord çš„ WebSocket proxy å¯èƒ½ä¸æœƒæ­£ç¢ºç™¼é€ close eventï¼Œå°è‡´ Nakama ç„¡æ³•è§¸ç™¼ `matchLeave`ï¼Œå°æ‰‹æ°¸é çœ‹ä¸åˆ°æ–·ç·šæç¤ºã€‚

#### å»ºè­°å¯¦ä½œ
1. **Client å®šæœŸç™¼é€å¿ƒè·³**
   - æ–°å¢ `HEARTBEAT` OpCode
   - Client æ¯ 5 ç§’ç™¼é€ä¸€æ¬¡å¿ƒè·³

2. **Server è¿½è¹¤å¿ƒè·³**
   - è¨˜éŒ„æ¯å€‹ç©å®¶æœ€å¾Œå¿ƒè·³æ™‚é–“ `lastHeartbeatTick`
   - Match loop æª¢æŸ¥ï¼šè‹¥è¶…é 15 ç§’æ²’æ”¶åˆ°å¿ƒè·³ï¼Œè¦–ç‚ºæ–·ç·š
   - è§¸ç™¼èˆ‡ `matchLeave` ç›¸åŒçš„æ–·ç·šè™•ç†æµç¨‹

#### æ³¨æ„äº‹é …
- å¿ƒè·³é–“éš”å’Œè¶…æ™‚æ™‚é–“éœ€è¦å¹³è¡¡ï¼ˆå¤ªçŸ­æœƒå¢åŠ æµé‡ï¼Œå¤ªé•·åæ‡‰æ…¢ï¼‰
- éœ€è¦è™•ç†ç¶²è·¯å»¶é²é€ æˆçš„èª¤åˆ¤

---

## ç¸½è¦½

| ID | æ¨™é¡Œ | å„ªå…ˆç´š | ç‹€æ…‹ |
|----|------|--------|------|
| FEAT-001 | é€é curl æŸ¥è©¢ä¼ºæœå™¨ç«¯ log | Low | ğŸ“ Planned |
| FEAT-002 | è¨­å®š Zeabur Watch Paths | Low | ğŸ“ Planned |
| FEAT-003 | é€£ç·šæ¢å¾©æ©Ÿåˆ¶ | Medium | âœ… Completed |
| FEAT-004 | Client ç‰ˆæœ¬æª¢æŸ¥è‡ªå‹•æ›´æ–° | Medium | ğŸ“ Planned (åœç”¨ä¸­) |
| FEAT-005 | Server ç«¯å¿ƒè·³æ©Ÿåˆ¶åµæ¸¬æ–·ç·š | Medium | ğŸ“ Planned |
